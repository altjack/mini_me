# =============================================================================
# Render Blueprint - Daily Report
# 
# Questo file configura automaticamente tutti i servizi su Render.
# Per usarlo: Dashboard Render → New → Blueprint → Collega questo repo
# =============================================================================

databases:
  # PostgreSQL Database per metriche GA4
  - name: daily-report-db
    databaseName: daily_report
    user: daily_report_user
    plan: free  # 256MB, sufficiente per staging
    region: frankfurt  # EU region per latenza

services:
  # =============================================================================
  # BACKEND - Flask API
  # =============================================================================
  - type: web
    name: daily-report-api
    env: python
    plan: free
    region: frankfurt
    
    # Build & Start
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn api:app --bind 0.0.0.0:$PORT --workers 2 --timeout 120
    
    # Health Check
    healthCheckPath: /api/health
    
    # Environment Variables
    envVars:
      # Database (auto-populated da Render)
      - key: DATABASE_URL
        fromDatabase:
          name: daily-report-db
          property: connectionString
      
      # Python
      - key: PYTHON_VERSION
        value: "3.12.0"
      
      # Basic Auth per staging (CONFIGURA QUESTI!)
      - key: STAGING_USER
        sync: false  # Richiede input manuale
      - key: STAGING_PASSWORD
        sync: false  # Richiede input manuale
      
      # API Key per endpoint protetti (opzionale)
      - key: API_SECRET_KEY
        generateValue: true
      
      # CORS - URL frontend (aggiornare dopo deploy frontend)
      - key: CORS_ORIGINS
        sync: false
      
      # Anthropic API Key (CONFIGURA QUESTO!)
      - key: ANTHROPIC_API_KEY
        sync: false  # Richiede input manuale
      
      # Google Credentials (CONFIGURA QUESTO!)
      # Incolla il contenuto JSON del file credentials/token.json
      - key: GOOGLE_CREDENTIALS_JSON
        sync: false  # Richiede input manuale

  # =============================================================================
  # FRONTEND - React Static Site
  # =============================================================================
  - type: web
    name: daily-report-frontend
    env: static
    
    # Build (debug: mostra contenuto per capire path su Render)
    buildCommand: |
      pwd
      ls -la
      ls -la src || true
      ls -la src/frontend || true
      cd src/frontend
      npm install
      npm run build
    staticPublishPath: src/frontend/dist
    
    # Headers per SPA routing
    headers:
      - path: /*
        name: Cache-Control
        value: no-cache
    
    # Redirect per SPA (tutte le route → index.html)
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    
    # Environment Variables per build
    envVars:
      # URL Backend API (aggiornare dopo deploy backend)
      - key: VITE_API_URL
        sync: false  # Da configurare manualmente con URL backend
      
      # Basic Auth credenziali (stesse del backend)
      - key: VITE_STAGING_USER
        sync: false
      - key: VITE_STAGING_PASSWORD
        sync: false
      
      # API Key (opzionale, per endpoint protetti)
      - key: VITE_API_KEY
        sync: false

